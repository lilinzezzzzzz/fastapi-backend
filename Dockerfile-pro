FROM python:3.12.9-slim

ENV TZ=Etc/UTC \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_INDEX_URL=https://mirrors.aliyun.com/pypi/simple \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# 安装 curl 和 bash，以便后续使用
RUN apt-get update && apt-get install -y curl bash && rm -rf /var/lib/apt/lists/*

# 安装 uv 并将其添加到 PATH
RUN curl -LsSf https://astral.sh/uv/install.sh | bash && \
    echo "UV_PATH=/root/.local/bin" >> /etc/environment && \
    ln -s /root/.local/bin/uv /usr/local/bin/uv

# 更新 PATH 环境变量，使得 uv 可以被访问
ENV PATH="/root/.local/bin:$PATH"

# 确认 uv 安装是否成功
RUN uv --version

# 拷贝业务代码（放在后面，改代码不破坏前面的缓存）
COPY . .

# 使用 uv 来同步并安装依赖
RUN uv venv

RUN bash -c "source .venv/bin/activate"

# 暴露端口
EXPOSE 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD ss -lnt | grep -q 8000 || exit 1

# 运行 FastAPI 应用
ENTRYPOINT ["bash", "-c", "source .venv/bin/activate && uvicorn main:app --host 0.0.0.0 --port 8000 --loop uvloop --http httptools --access-log"]