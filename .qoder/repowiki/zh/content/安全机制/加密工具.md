# 加密工具

<cite>
**本文档引用的文件**   
- [crypto.py](file://internal/core/crypto.py)
- [aes.py](file://pkg/crypto/aes.py)
- [base.py](file://pkg/crypto/base.py)
- [.secrets.example](file://configs/.secrets.example)
- [load_config.py](file://internal/config/load_config.py)
- [test_crypto.py](file://tests/test_crypto.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心加密组件](#核心加密组件)
3. [加密架构与设计模式](#加密架构与设计模式)
4. [AES加密实现](#aes加密实现)
5. [配置文件中的加密支持](#配置文件中的加密支持)
6. [密钥管理与初始化](#密钥管理与初始化)
7. [加密工具的使用方法](#加密工具的使用方法)
8. [测试与验证](#测试与验证)

## 项目结构

该项目采用分层架构设计，加密相关功能主要分布在`pkg/crypto`和`internal/core`目录下。`pkg/crypto`包提供了通用的加密算法实现，而`internal/core`则负责与应用核心逻辑的集成。

```mermaid
graph TD
A[pkg/crypto] --> B[aes.py]
A --> C[base.py]
A --> D[__init__.py]
E[internal/core] --> F[crypto.py]
G[internal/config] --> H[load_config.py]
I[configs] --> J[.secrets.example]
K[tests] --> L[test_crypto.py]
```

**图示来源**
- [aes.py](file://pkg/crypto/aes.py)
- [base.py](file://pkg/crypto/base.py)
- [crypto.py](file://internal/core/crypto.py)
- [load_config.py](file://internal/config/load_config.py)
- [.secrets.example](file://configs/.secrets.example)
- [test_crypto.py](file://tests/test_crypto.py)

## 核心加密组件

系统中的加密功能由多个核心组件构成，形成了一个完整的加密解决方案。这些组件包括基础加密类、具体算法实现、工厂模式和便捷函数。

```mermaid
classDiagram
class BaseCryptoUtil {
<<abstract>>
+__init__(key : str | bytes)
+encrypt(plain_text : str) str
+decrypt(cipher_text : str) str
}
class AESCipher {
+__init__(key : str | bytes)
+generate_key() str
+encrypt(plain_text : str) str
+decrypt(cipher_text : str) str
}
class EncryptionAlgorithm {
<<enumeration>>
AES
}
class register_algorithm {
+register_algorithm(algo : EncryptionAlgorithm)
}
BaseCryptoUtil <|-- AESCipher
register_algorithm --> AESCipher : "装饰器注册"
EncryptionAlgorithm --> AESCipher : "算法枚举"
```

**图示来源**
- [base.py](file://pkg/crypto/base.py#L26-L38)
- [aes.py](file://pkg/crypto/aes.py#L7-L44)
- [base.py](file://pkg/crypto/base.py#L6-L8)

**本节来源**
- [base.py](file://pkg/crypto/base.py)
- [aes.py](file://pkg/crypto/aes.py)

## 加密架构与设计模式

系统采用了工厂模式和策略模式相结合的设计，通过注册表机制实现了加密算法的灵活扩展。这种设计允许在不修改现有代码的情况下添加新的加密算法。

```mermaid
sequenceDiagram
participant 应用层
participant 工厂函数
participant 注册表
participant AES实现
应用层->>工厂函数 : get_crypto_class(algo=AES)
工厂函数->>注册表 : 查询_AES_REGISTRY
注册表-->>工厂函数 : 返回AESCipher类
工厂函数-->>应用层 : AESCipher类
应用层->>AES实现 : 实例化并调用加密方法
```

**图示来源**
- [__init__.py](file://pkg/crypto/__init__.py#L23-L34)
- [base.py](file://pkg/crypto/base.py#L11-L23)
- [aes.py](file://pkg/crypto/aes.py#L6-L7)

**本节来源**
- [__init__.py](file://pkg/crypto/__init__.py)
- [base.py](file://pkg/crypto/base.py)

## AES加密实现

AES加密实现基于`cryptography`库的Fernet方案，提供了安全的对称加密功能。该实现具有自动密钥验证、空值处理和异常处理等特性。

```mermaid
flowchart TD
A[开始] --> B{明文为空?}
B --> |是| C[返回空字符串]
B --> |否| D[编码为UTF-8字节]
D --> E[Fernet加密]
E --> F[解码为UTF-8字符串]
F --> G[返回密文]
H[开始] --> I{密文为空?}
I --> |是| J[返回空字符串]
I --> |否| K[编码为UTF-8字节]
K --> L[Fernet解密]
L --> M[解码为UTF-8字符串]
M --> N[返回明文]
L --> O[InvalidToken异常]
O --> P[抛出解密失败错误]
```

**图示来源**
- [aes.py](file://pkg/crypto/aes.py#L30-L43)

**本节来源**
- [aes.py](file://pkg/crypto/aes.py)

## 配置文件中的加密支持

系统支持在配置文件中使用加密值，通过ENC()格式标记加密内容。配置加载器会自动识别并解密这些值，确保敏感信息的安全存储。

```mermaid
sequenceDiagram
participant 配置加载器
participant 环境变量
participant 解密函数
participant 配置对象
配置加载器->>环境变量 : 加载.secrets文件
环境变量-->>配置加载器 : AES_SECRET密钥
配置加载器->>配置对象 : 创建配置实例
配置对象->>解密函数 : 检测ENC()格式
解密函数->>解密函数 : 使用AES_SECRET解密
解密函数-->>配置对象 : 返回明文
配置对象-->>应用 : 提供解密后的配置值
```

**图示来源**
- [load_config.py](file://internal/config/load_config.py#L129-L160)
- [.secrets.example](file://configs/.secrets.example)

**本节来源**
- [load_config.py](file://internal/config/load_config.py)
- [.secrets.example](file://configs/.secrets.example)

## 密钥管理与初始化

系统的密钥管理遵循安全最佳实践，密钥存储在独立的.secrets文件中，不纳入版本控制。应用启动时会自动加载密钥并初始化加密组件。

```mermaid
flowchart TD
A[应用启动] --> B{.secrets文件存在?}
B --> |否| C[抛出文件未找到错误]
B --> |是| D[加载密钥到环境变量]
D --> E[获取APP_ENV]
E --> F{APP_ENV有效?}
F --> |否| G[抛出值错误]
F --> |是| H[初始化配置]
H --> I[初始化AES加密器]
I --> J[应用就绪]
```

**图示来源**
- [load_config.py](file://internal/config/load_config.py#L17-L74)
- [crypto.py](file://internal/core/crypto.py#L6-L8)

**本节来源**
- [load_config.py](file://internal/config/load_config.py)
- [crypto.py](file://internal/core/crypto.py)

## 加密工具的使用方法

系统提供了多种方式使用加密功能，包括直接实例化、工厂函数和便捷函数。开发者可以根据具体场景选择最适合的使用方式。

```mermaid
classDiagram
class 便捷函数 {
+aes_encrypt(plaintext, secret_key)
+aes_decrypt(ciphertext, secret_key)
+aes_generate_key()
}
class 工厂模式 {
+get_crypto_class(algo)
}
class 直接实例化 {
+AESCipher(key)
}
便捷函数 --> AESCipher : 内部调用
工厂模式 --> AESCipher : 返回实例
直接实例化 --> AESCipher : 创建实例
```

**图示来源**
- [aes.py](file://pkg/crypto/aes.py#L46-L58)
- [__init__.py](file://pkg/crypto/__init__.py#L23-L34)
- [aes.py](file://pkg/crypto/aes.py#L13-L19)

**本节来源**
- [aes.py](file://pkg/crypto/aes.py)
- [__init__.py](file://pkg/crypto/__init__.py)

## 测试与验证

系统包含完整的加密功能测试套件，覆盖了加密解密循环、密钥验证、异常处理等多个方面，确保加密功能的正确性和可靠性。

```mermaid
flowchart TD
A[测试套件] --> B[密钥生成测试]
A --> C[加密解密循环测试]
A --> D[IV机制测试]
A --> E[错误密钥测试]
A --> F[篡改数据测试]
A --> G[空值处理测试]
A --> H[便捷函数测试]
B --> I[验证生成的密钥格式]
C --> J[验证加密后可正确解密]
D --> K[验证相同明文产生不同密文]
E --> L[验证错误密钥无法解密]
F --> M[验证篡改密文导致解密失败]
G --> N[验证空字符串处理]
H --> O[验证便捷函数正确性]
```

**图示来源**
- [test_crypto.py](file://tests/test_crypto.py#L102-L211)

**本节来源**
- [test_crypto.py](file://tests/test_crypto.py)