# 测试策略

<cite>
**本文档引用的文件**
- [pyproject.toml](file://pyproject.toml)
- [tests/test_anyio_file.py](file://tests/test_anyio_file.py)
- [tests/test_context.py](file://tests/test_context.py)
- [tests/test_logger.py](file://tests/test_logger.py)
- [tests/test_logger_json_content.py](file://tests/test_logger_json_content.py)
- [tests/test_logger_rotation.py](file://tests/test_logger_rotation.py)
- [tests/test_anyio_task.py](file://tests/test_anyio_task.py)
- [tests/test_orm.py](file://tests/test_orm.py)
- [configs/.env.test](file://configs/.env.test)
- [pkg/logger_tool.py](file://pkg/logger_tool.py)
- [pkg/anyio_file.py](file://pkg/anyio_file.py)
- [pkg/ctx.py](file://pkg/ctx.py)
- [pkg/database.py](file://pkg/database.py)
</cite>

## 目录
1. [项目测试概览](#项目测试概览)
2. [测试框架配置](#测试框架配置)
3. [测试用例覆盖范围](#测试用例覆盖范围)
4. [异步测试实践](#异步测试实践)
5. [测试工具与辅助](#测试工具与辅助)
6. [测试数据库配置](#测试数据库配置)
7. [测试运行与覆盖率](#测试运行与覆盖率)
8. [CI/CD 集成](#cicd-集成)
9. [测试最佳实践](#测试最佳实践)
10. [编写新测试用例指南](#编写新测试用例指南)

## 项目测试概览

FastAPI 后端项目采用全面的测试策略，涵盖异步文件操作、上下文管理、日志系统、ORM 数据库查询等多个核心功能模块。项目使用 pytest 作为主要测试框架，并结合 pytest-asyncio 支持异步测试。

### 测试架构设计

```mermaid
graph TB
subgraph "测试架构"
A[pytest 主框架] --> B[pytest-asyncio 异步支持]
A --> C[测试夹具系统]
A --> D[Mock 系统]
B --> E[Anyio 文件操作测试]
B --> F[上下文管理测试]
B --> G[异步任务管理测试]
B --> H[ORM 数据库测试]
C --> I[数据库连接池]
C --> J[日志配置]
C --> K[Redis 连接]
D --> L[外部服务 Mock]
D --> M[数据库 Mock]
D --> N[HTTP 客户端 Mock]
end
```

**图表来源**
- [pyproject.toml](file://pyproject.toml#L71-L72)
- [tests/test_orm.py](file://tests/test_orm.py#L1-L50)

**章节来源**
- [pyproject.toml](file://pyproject.toml#L71-L72)
- [tests/test_anyio_file.py](file://tests/test_anyio_file.py#L1-L20)
- [tests/test_context.py](file://tests/test_context.py#L1-L30)

## 测试框架配置

### 核心依赖配置

项目在 `pyproject.toml` 中明确配置了测试相关的依赖：

```mermaid
graph LR
A[pytest 9.0.1] --> B[核心测试框架]
C[pytest-asyncio] --> D[异步测试支持]
E[httpx] --> F[HTTP 请求测试]
B --> G[测试发现与执行]
D --> H[协程测试]
F --> I[API 接口测试]
```

**图表来源**
- [pyproject.toml](file://pyproject.toml#L71-L74)

### 环境配置

测试环境使用专门的配置文件，确保测试隔离：

| 配置项 | 值 | 用途 |
|--------|-----|------|
| MYSQL_DATABASE | xxx_db_test | 测试专用数据库 |
| REDIS_DB | 0 | 测试专用 Redis 数据库 |
| SECRET_KEY | test-SECRET_KEY | 测试密钥 |

**章节来源**
- [pyproject.toml](file://pyproject.toml#L71-L74)
- [configs/.env.test](file://configs/.env.test#L1-L14)

## 测试用例覆盖范围

### 异步文件操作测试 (anyio_file)

测试模块涵盖了 `AnyioFile` 类的所有核心功能：

```mermaid
flowchart TD
A[AnyioFile 测试] --> B[文件基本操作]
A --> C[读写模式测试]
A --> D[目录操作测试]
A --> E[分块读取测试]
A --> F[错误处理测试]
B --> B1[exists() 存在性检查]
B --> B2[unlink() 删除操作]
B --> B3[stat() 文件状态]
C --> C1[text 模式读写]
C --> C2[binary 模式读写]
D --> D1[mkdir() 目录创建]
D --> D2[ensure_parent 自动创建]
E --> E1[read_chunks() 分块读取]
E --> E2[read_lines() 行读取]
```

**图表来源**
- [tests/test_anyio_file.py](file://tests/test_anyio_file.py#L10-L160)

### 上下文管理测试 (ctx)

测试验证了请求上下文的生命周期管理和并发安全性：

```mermaid
sequenceDiagram
participant Test as 测试用例
participant CM as ContextManager
participant CV as ContextVar
participant Logger as 日志系统
Test->>CM : init(trace_id)
CM->>CV : 设置上下文
Test->>CM : set_user_id(1001)
CM->>CV : 存储用户ID
Test->>CM : get_user_id()
CM->>CV : 获取用户ID
CV-->>CM : 返回 1001
CM-->>Test : 返回 1001
Note over Test,Logger : 并发测试场景
Test->>CM : 并发请求 A/B
CM->>CV : 确保上下文隔离
CV-->>CM : 隔离的上下文
CM-->>Test : 正确的结果
```

**图表来源**
- [tests/test_context.py](file://tests/test_context.py#L30-L109)
- [pkg/ctx.py](file://pkg/ctx.py#L9-L58)

### 日志系统测试 (logger_tool)

日志系统的测试覆盖了多种场景：

| 测试类别 | 功能点 | 测试重点 |
|----------|--------|----------|
| 基础功能 | 系统日志记录 | 文本格式输出、文件轮转 |
| JSON 内容 | 动态日志类型 | JSON 格式序列化、字段提取 |
| 轮转机制 | 文件轮转策略 | 时间轮转、大小轮转 |
| 保留策略 | 文件清理 | 保留期限、过期删除 |
| 错误处理 | 异常降级 | 权限错误、路径错误 |

**章节来源**
- [tests/test_logger.py](file://tests/test_logger.py#L1-L147)
- [tests/test_logger_json_content.py](file://tests/test_logger_json_content.py#L1-L154)
- [tests/test_logger_rotation.py](file://tests/test_logger_rotation.py#L1-L95)

### ORM 数据库测试

ORM 测试验证了 SQLAlchemy 异步操作的完整性：

```mermaid
classDiagram
class ModelMixin {
+create() ModelMixin
+save(session_provider) void
+update(session_provider, kwargs) void
+soft_delete(session_provider) void
}
class BaseDao~T~ {
+query_by_primary_id(id) T
+query_by_ids(ids) List[T]
+counter Counter
+querier QueryBuilder
}
class User {
+username : str
+email : str
}
ModelMixin <|-- User
BaseDao --> ModelMixin : manages
```

**图表来源**
- [tests/test_orm.py](file://tests/test_orm.py#L65-L73)
- [pkg/database.py](file://pkg/database.py#L74-L200)

**章节来源**
- [tests/test_orm.py](file://tests/test_orm.py#L1-L227)

## 异步测试实践

### pytest-asyncio 配置

项目使用 `pytest-asyncio` 支持异步测试，配置方式如下：

```mermaid
flowchart LR
A[测试标记] --> B[@pytest.mark.anyio]
A --> C[@pytest.mark.asyncio]
B --> D[异步测试函数]
C --> E[协程测试函数]
D --> F[async def test_xxx]
E --> G[async def test_xxx]
F --> H[await 操作]
G --> I[await 操作]
```

**图表来源**
- [tests/test_anyio_file.py](file://tests/test_anyio_file.py#L7-L8)
- [tests/test_context.py](file://tests/test_context.py#L91-L109)

### 异步测试模式

项目采用多种异步测试模式：

| 测试模式 | 使用场景 | 示例 |
|----------|----------|------|
| 协程测试 | 单个异步函数 | `@pytest.mark.asyncio` |
| 异步类测试 | 多个异步方法 | `@pytest.mark.anyio` |
| 并发测试 | 并发场景验证 | `asyncio.create_task()` |
| 超时测试 | 超时处理验证 | `pytest.raises(asyncio.TimeoutError)` |

**章节来源**
- [tests/test_anyio_file.py](file://tests/test_anyio_file.py#L7-L160)
- [tests/test_anyio_task.py](file://tests/test_anyio_task.py#L67-L235)

## 测试工具与辅助

### Mock 系统

项目使用多层次的 Mock 策略：

```mermaid
graph TB
A[Mock 策略] --> B[模块级别 Mock]
A --> C[函数级别 Mock]
A --> D[对象级别 Mock]
B --> B1[sys.modules 模拟]
B --> B2[动态模块创建]
C --> C1[MagicMock 函数]
C --> C2[lambda 替代]
D --> D1[对象属性 Mock]
D --> D2[方法行为 Mock]
```

**图表来源**
- [tests/test_orm.py](file://tests/test_orm.py#L16-L50)

### 测试夹具系统

测试夹具提供了标准化的测试环境：

| 夹具类型 | 功能 | 使用场景 |
|----------|------|----------|
| db_session | 数据库连接池 | ORM 测试 |
| logger_setup | 日志配置 | 日志测试 |
| clean_context | 上下文清理 | 上下文测试 |
| manager | 任务管理器 | 异步任务测试 |

**章节来源**
- [tests/test_orm.py](file://tests/test_orm.py#L78-L94)
- [tests/test_context.py](file://tests/test_context.py#L21-L27)

## 测试数据库配置

### 内存数据库测试

项目使用 SQLite 内存数据库进行测试，确保测试隔离：

```mermaid
flowchart TD
A[测试启动] --> B[创建内存数据库]
B --> C[初始化表结构]
C --> D[执行测试]
D --> E[清理资源]
E --> F[销毁数据库]
B --> B1[sqlite+aiosqlite:///:memory:]
C --> C1[Base.metadata.create_all]
E --> E1[engine.dispose]
```

**图表来源**
- [tests/test_orm.py](file://tests/test_orm.py#L82-L94)

### 数据库连接配置

测试数据库使用专门的连接配置：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 数据库类型 | sqlite+aiosqlite | 异步 SQLite |
| 连接方式 | :memory: | 内存数据库 |
| 回调检测 | pool_pre_ping=True | 连接健康检查 |
| 连接池大小 | pool_size=10 | 最大连接数 |
| 超出限制 | max_overflow=20 | 最大溢出连接 |

**章节来源**
- [tests/test_orm.py](file://tests/test_orm.py#L30-L52)
- [configs/.env.test](file://configs/.env.test#L3-L8)

## 测试运行与覆盖率

### 测试命令配置

项目使用标准的 pytest 命令运行测试：

```bash
# 基本测试运行
pytest

# 异步测试运行
pytest -v --asyncio-mode=auto

# 指定测试文件
pytest tests/test_anyio_file.py

# 生成覆盖率报告
pytest --cov=pkg --cov-report=html
```

### 测试覆盖率策略

| 覆盖率类型 | 目标 | 工具 |
|------------|------|------|
| 行覆盖率 | >90% | coverage.py |
| 分支覆盖率 | >85% | coverage.py |
| 函数覆盖率 | >95% | pytest-cov |
| 模块覆盖率 | >80% | pytest-cov |

### 测试报告生成

```mermaid
flowchart LR
A[测试执行] --> B[覆盖率收集]
B --> C[HTML 报告生成]
B --> D[XML 报告生成]
B --> E[JSON 报告生成]
C --> F[浏览器查看]
D --> G[CI/CD 集成]
E --> H[第三方工具]
```

## CI/CD 集成

### 测试流水线设计

```mermaid
graph LR
A[代码提交] --> B[依赖安装]
B --> C[环境配置]
C --> D[单元测试]
D --> E[集成测试]
E --> F[覆盖率检查]
F --> G[测试报告]
D --> D1[pytest 执行]
E --> E1[数据库测试]
F --> F1[覆盖率验证]
G --> G1[报告发布]
```

### CI 环境要求

| 环境组件 | 版本要求 | 用途 |
|----------|----------|------|
| Python | >=3.12 | 运行时环境 |
| uv | 最新版本 | 包管理器 |
| MySQL | 8.0+ | 数据库测试 |
| Redis | 6.0+ | 缓存测试 |

**章节来源**
- [docs/uv_use_guide.md](file://docs/uv_use_guide.md#L113-L128)

## 测试最佳实践

### 测试命名规范

```mermaid
flowchart TD
A[测试命名] --> B[功能测试]
A --> C[边界测试]
A --> D[异常测试]
B --> B1[test_functionality_name]
C --> C1[test_boundary_condition]
D --> D1[test_exception_handling]
B1 --> E[清晰表达测试目的]
C1 --> F[验证边界条件]
D1 --> G[验证错误处理]
```

### 测试数据管理

| 数据类型 | 管理方式 | 示例 |
|----------|----------|------|
| 静态数据 | 固定值 | 测试常量 |
| 动态数据 | 生成器 | 随机 ID |
| 外部数据 | Mock | API 响应 |
| 数据库数据 | 测试数据库 | 内存数据库 |

### 测试隔离原则

```mermaid
graph TB
A[测试隔离] --> B[状态隔离]
A --> C[资源隔离]
A --> D[环境隔离]
B --> B1[上下文清理]
B --> B2[全局状态重置]
C --> C1[数据库连接池]
C --> C2[文件系统隔离]
D --> D1[独立环境变量]
D --> D2[不同配置文件]
```

## 编写新测试用例指南

### 测试用例结构模板

```python
@pytest.mark.asyncio
async def test_feature_name():
    """测试功能的简短描述
    
    验证要点：
    - 功能点1
    - 功能点2
    - 边界条件
    """
    
    # Arrange - 准备阶段
    setup_data = create_test_data()
    
    # Act - 执行阶段
    result = await target_function(setup_data)
    
    # Assert - 断言阶段
    assert result is not None
    assert result.property == expected_value
```

### Mock 外部依赖

```mermaid
flowchart TD
A[识别外部依赖] --> B[选择 Mock 策略]
B --> C[模块级别 Mock]
B --> D[函数级别 Mock]
B --> E[对象级别 Mock]
C --> C1[sys.modules 替换]
D --> D1[MagicMock 函数]
E --> E1[部分 Mock 对象]
C1 --> F[适用于整个模块]
D1 --> G[适用于特定函数]
E1 --> H[适用于对象方法]
```

### 测试数据库操作

```python
@pytest_asyncio.fixture
async def test_database():
    """测试数据库夹具"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    session_maker = new_async_session_maker(engine)
    yield session_maker
    
    await engine.dispose()

async def test_database_operation(test_database):
    """测试数据库操作"""
    # 使用 test_database 夹具
    dao = UserDao(session_provider=test_database, model_cls=User)
    
    # 执行测试
    user = User.create(username="test_user")
    await user.save(test_database)
    
    # 验证结果
    db_user = await dao.query_by_primary_id(user.id)
    assert db_user.username == "test_user"
```

### 异步测试最佳实践

| 实践原则 | 说明 | 示例 |
|----------|------|------|
| 明确异步标记 | 使用正确的测试标记 | `@pytest.mark.asyncio` |
| 资源清理 | 确保异步资源正确释放 | `await manager.shutdown()` |
| 超时处理 | 为异步操作设置合理超时 | `pytest.raises(asyncio.TimeoutError)` |
| 并发测试 | 验证并发安全性 | `asyncio.create_task()` |

### 测试调试技巧

```mermaid
flowchart LR
A[测试失败] --> B[检查日志]
A --> C[断点调试]
A --> D[逐步验证]
B --> B1[pytest -v]
C --> C1[pytest --pdb]
D --> D1[分步测试]
B1 --> E[详细输出]
C1 --> F[交互调试]
D1 --> G[问题定位]
```

**章节来源**
- [tests/test_anyio_file.py](file://tests/test_anyio_file.py#L1-L160)
- [tests/test_context.py](file://tests/test_context.py#L1-L109)
- [tests/test_logger.py](file://tests/test_logger.py#L1-L147)
- [tests/test_orm.py](file://tests/test_orm.py#L1-L227)